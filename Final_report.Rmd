---
title: "Final_report"
author: "R.Riddell"
date: "26/04/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(broom)
```
Introduction
- relevant background information of basketball, including key metrics, position requirements etc
- description of the scenario
- the aim of the project
- justification and importance

Reading and cleaning the raw data
This section should document the process used to read and clean the raw data. It should also include a description of the data sets used and variables in each. For brevity, you could provide a link to the specific variable descriptions, rather than writing these out in full within your report. 
[Data Descriptions](https://github.com/RobertRiddell/Final-Project_10157/tree/main/data-descriptions)

[Calcualte Effectiev Field Goal] (https://www.basketball-reference.com/about/glossary.html#:~:text=eFG%25%20%2D%20Effective%20Field%20Goal%20Percentage,a%202%2Dpoint%20field%20goal.)
```{r Player Stats}
# Running the cleaning scripts from the funs folder to seperate the cleaninig and model analysis
source("funs/clean_player-stats.R")
```

```{r Team stats}
# Running the cleaning scripts from the funs folder to seperate the cleaninig and model analysis
source("funs/clean_team-stats.R")
```

Exploratory analysis
This section should document your exploratory data analysis and may include but is not limited to:
- checking for errors and missing values within the datasets
- checking the distribution of variables
- checking for relationships between variables, or differences between groups
- justification for decisions made about data modelling
Note that this section and the data cleaning section may be an iterative process, as you might find things about the data that need to be 'cleaned up' once you have explored the data further. 
```{r}
tm_stats <- read_csv("data/processed/cleaned_team-stats.csv")
sum(is.na(tm_stats))

ggplot(tm_stats, aes(w, pts)) +
  geom_point() + 
  geom_smooth(method = "lm", se = F, linetype = "dashed", colour = "red")

cor(tm_stats$w, tm_stats$pts)

# convert stats to per game
tm_stats <- tm_stats %>% 
  mutate(mp = mp/g,
            fg = fg/g,
            fga = fga/g,
            fg_percent = fg/fga,
            x3p = x3p/g,
            x3pa = x3pa/g,
            x3p_percent = x3p/x3pa,
            x2p = x2p/g,
            x2pa = x2pa/g,
            x2p_percent = x2p/x2pa, 
            ft = ft/g,
            fta = fta/g,
            ft_percent = ft/fta,
            orb = orb/g,
            drb = drb/g,
            trb = trb/g,
            ast = ast/g,
            stl = stl/g,
            blk = blk/g,
            tov = tov/g,
            pf = pf/g,
            pts = pts/g)

# variables removed as they will not add to predicting points scored
team <- tm_stats$team

tm_stats <- tm_stats %>% 
  select(!c(g, rk,team, team_id, salary, w))

  
ggplot(tm_stats, aes(pts)) +
  geom_histogram(colour = '#048BA8', fill = '#16DB93', alpha = 0.8, binwidth = 2) 

source("funs/gg_scatter.R")

numeric_vars <- tm_stats %>% 
  select(where(is.numeric),- pts) %>% 
  names(.)

for (i in seq_along(numeric_vars)) {
  print(gg_scatter(tm_stats, numeric_vars[i]))
}

tm_stats %>% 
  select(is.numeric) %>% 
  corrr::correlate() %>% 
  corrr::focus(pts) %>%
  arrange(pts) 

# remove low correlations between -0.2 and 0.2
tm_stats <- tm_stats %>% 
  select(!c(x2pa, mp, tov, pf, ft_percent, stl, orb))

# Remove obvious variables that impact each other
GGally::ggcorr(tm_stats, method = c('pairwise','spearman'), 
               size = 2 )

tm_stats <- tm_stats %>% 
  select(!c(e_fg_percent, ft_fga, fg, x3p, x3p_ar, ft, fta, drb, fg_percent, x2p_percent, x3p_percent))

# removed as it shows low linear relationship in the car::avPlots(fit)
tm_stats <- tm_stats %>% 
  select(!blk)

# Removes as the confint for the slope was -1.043498e-03	4.461750e-02 
tm_stats <- tm_stats %>% 
  select(!c(x3pa, x2p, trb, ast))

```
Data modelling and results
This section may include but is not limited to:
- data modelling (e.g. creating a linear regression)
- assumption checking
- model output and interpretation of your model
```{r}
# Model
fit <- lm(pts ~ ., tm_stats)
tidy(fit, conf.int = T)
summary(fit)
```


```{r}
# Linearity
car::avPlots(fit)
```

```{r}
# multicolinearty
cor_mat <- tm_stats %>% 
  select(where(is.numeric)) %>% 
  cor(., method = 'spearman')

# select the variables that display multicolinearty above 0.8
cor_features <- caret::findCorrelation(cor_mat, cutoff = 0.8, names = T, exact = FALSE)

# Variance Inflation Factor
car::vif(fit)
sqrt(car::vif(fit))
```

```{r}
#outliers
std_res <- rstandard(fit)
points <- 1:length(std_res)
ggplot(NULL, aes(points, std_res)) +
  geom_point() +
  ylim(c(-4,4)) +
  geom_hline(yintercept = c(-3,3) , colour = "red", linetype = "dashed")

# no obvious outliers
```

```{r}
# Leverage points
tmpdf <- tm_stats 
tmpdf$hats <- hatvalues(fit)
lev_labels <- if_else(tmpdf$hats >= 0.4, paste(team), "")

ggplot(tmpdf, aes(points, hats)) +
  geom_point() +
  ggrepel::geom_text_repel(aes(label = lev_labels), colour = "navy")

```

```{r}
# Influence
cook <- cooks.distance(fit)
cook_labels <- if_else(cook >= 1, paste(team), "")

ggplot(NULL, aes(points, cook)) +
  geom_point() +
  ggrepel::geom_text_repel(aes(label = cook_labels), colour = "navy")


```

```{r}
# Independence
car::durbinWatsonTest(fit)
# can range from 0 - 4
# 2 means observations are independent

```

```{r}
# Homoscedasticity
res <- residuals(fit)
fitted <- predict(fit)
res_labels <- if_else(res >= .1 | res <= -.12, paste(team), "")


ggplot(NULL, aes(fitted, res)) +
  geom_point() +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  ggrepel::geom_text_repel(aes(label = res_labels), colour = "navy")

# ideally a random spread with no clear pattern


```

```{r}
# Normality of residuals

ggplot(NULL, aes(res)) +
  geom_histogram(binwidth = .07)

ggplot(NULL, aes(sample =res)) +
  stat_qq() +
  stat_qq_line()

```


Player recommendations
This section will be the key part that is presented to the general manager. Here you should present your recommendations for the best five starting players, but also think about what other important information they would want to know, and how it is best to present that information to them. 
```{r}
team_mins <- read_csv("data/processed/cleaned_team-stats.csv")

min_per_game <- team_mins %>% 
  group_by(team) %>% 
  summarise(ave_mins = mean(mp)/ g) %>% 
  pull %>% 
  mean

player_stats <- read_csv("data/processed/cleaned_player-stats.csv")

players <- player_stats %>% 
  group_by(player_name) %>% 
  summarise(G = sum(mp)/ min_per_game,
            f_tr = (fta/fga),
            ts_percent = pts / ((.44*fta + fga)*2),
            fga = sum(fga)/G,
            x3pa = sum(x3pa)/G,
            x2p = sum(x2p)/G,
            trb = sum(trb)/G,
            ast = sum(ast)/G,
            blk = sum(blk)/G,
            MP = sum(mp)) %>% 
  select(-G) 
```

```{r}
player_stats <-  player_stats %>% 
  select(player_name, age, Pos, Tm, mp)

player_salary <- read_csv("data/raw/2018-19_nba_player-salaries.csv")

player_stats <- left_join(player_stats, player_salary, by= "player_name")

players <- mutate(players, exp_pts = predict(fit, newdata = players))

players <- players %>% 
  select(player_name, exp_pts)

player_stats <- left_join(player_stats, players, by = "player_name")

player_stats %>% 
  select(player_name, age, mp, Pos, salary, exp_pts) %>% 
  filter(mp > 300) %>% 
  arrange(-exp_pts)


```

Summary 
Provide a brief summary which describes the key points and findings from your project. It will also be important to acknowledge any limitations of your model and overall approach to answering the question asked of you by the general manager.
```{r}

30570000 + 3314365 + 7839435 + 8641000 + 23114066

# Harden, Booker, Karl - Anthony Towns, Julius Randle, Kyrie Irving
```
Reference List
Provide a reference list of any sources you used in the development of your report and justification of your arguments. Please use the Vancouver reference style (Links to an external site.) for the reference list and in-text references. 

 